<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µè€ƒé›»å­æ™‚é˜çœ‹æ¿</title>
    <!-- å¼•å…¥ Noto Sans TC å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* æ·ºè‰²ç³»é…è‰² */
            --bg-color: #f0f4f8;
            --sidebar-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-blue: #4299e1;  /* æ­£å¸¸è€ƒè©¦ */
            --accent-orange: #ed8936; /* å‰©é¤˜10åˆ†é˜ */
            --accent-red: #f56565;    /* å‰©é¤˜5åˆ†é˜ */
            --accent-green: #48bb78;  /* ä¼‘æ¯/å‚™èª² */
            --border-color: #e2e8f0;
            --highlight-bg: #ebf8ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* å·¦å´ä¸»ç•«é¢å€åŸŸ */
        .main-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 2rem;
        }

        /* é›»å­é˜æ¨£å¼ */
        .digital-clock-container {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .date-display {
            font-size: 2rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .time-display {
            font-size: 8rem;
            font-weight: 700;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            color: var(--text-primary);
        }
        
        /* æ ¡æ­£é¢æ¿æ¨£å¼ */
        .calibration-toggle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 10px;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        .calibration-toggle:hover { opacity: 1; }

        .calibration-panel {
            margin-top: 10px;
            display: none; /* é è¨­éš±è— */
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .calibration-panel.show { display: block; }

        .cal-btn {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .cal-btn:hover { background: var(--highlight-bg); border-color: var(--accent-blue); }
        .cal-info { font-size: 0.9rem; color: var(--accent-blue); margin-top: 5px; font-weight: bold; }


        /* Canvas å®¹å™¨ */
        .canvas-wrapper {
            position: relative;
            width: 450px;
            height: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            transform: rotate(-90deg); /* è®“åœ“ç’°èµ·é»åœ¨ 12 é»é˜æ–¹å‘ */
        }

        /* åœ“ç’°å…§éƒ¨çš„è³‡è¨Š */
        .circle-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 80%;
        }

        .subject-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            white-space: nowrap;
        }

        .status-message {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        /* æé†’è¨Šæ¯ (åº•éƒ¨é–ƒçˆå€) - çµ•å°å®šä½å›ºå®šç‰ˆé¢ */
        .alert-area {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            pointer-events: none; 
        }

        .alert-text {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-red);
            animation: pulse 1.5s infinite;
            display: none; 
            background-color: rgba(240, 244, 248, 0.95); 
            padding: 5px 30px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* å³å´å´é‚Šæ¬„ (è€ƒç¨‹è¡¨) */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 15px rgba(0,0,0,0.03);
            z-index: 10;
        }

        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            border-left: 5px solid var(--accent-blue);
            padding-left: 1rem;
        }

        .schedule-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* è€ƒç¨‹é …ç›®æ¨£å¼ */
        .schedule-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .item-time {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }

        .item-subject {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ç‹€æ…‹ï¼šå·²è€ƒå®Œ */
        .schedule-item.past {
            opacity: 0.4;
            background-color: #f7fafc;
        }

        /* ç‹€æ…‹ï¼šé€²è¡Œä¸­ */
        .schedule-item.active {
            background-color: var(--highlight-bg);
            border-color: var(--accent-blue);
            transform: translateX(-5px);
            box-shadow: 2px 4px 10px rgba(66, 153, 225, 0.1);
        }
        
        .schedule-item.active .item-subject {
            color: var(--accent-blue);
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .time-display { font-size: 6rem; }
            .canvas-wrapper { width: 350px; height: 350px; }
            .subject-title { font-size: 2.5rem; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; border-left: none; border-top: 1px solid var(--border-color); }
            .main-section { height: 100vh; }
        }
    </style>
</head>
<body>

    <!-- ä¸»ç•«é¢ -->
    <main class="main-section">
        <div class="digital-clock-container">
            <div class="date-display" id="dateDisplay">--æœˆ--æ—¥ æ˜ŸæœŸ--</div>
            <div class="time-display" id="timeDisplay">00:00:00</div>
            
            <!-- æ ¡æ­£é¢æ¿æŒ‰éˆ• -->
            <div class="calibration-toggle" onclick="toggleCalibration()">âš™ï¸ æ™‚é–“æ ¡æ­£</div>
            
            <!-- æ ¡æ­£æ§åˆ¶é … -->
            <div class="calibration-panel" id="calibrationPanel">
                <button class="cal-btn" onclick="adjustTime(-10000)">-10ç§’</button>
                <button class="cal-btn" onclick="adjustTime(-1000)">-1ç§’</button>
                <button class="cal-btn" onclick="resetCalibration()">æ­¸é›¶</button>
                <button class="cal-btn" onclick="adjustTime(1000)">+1ç§’</button>
                <button class="cal-btn" onclick="adjustTime(10000)">+10ç§’</button>
                <div class="cal-info" id="calInfo">ç›®å‰æ ¡æ­£: 0 ç§’</div>
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="examCanvas" width="450" height="450"></canvas>
            <div class="circle-info">
                <div class="subject-title" id="centerSubject">è¼‰å…¥ä¸­...</div>
                <div class="status-message" id="centerStatus">è«‹ç¢ºèª CSV æª”æ¡ˆ</div>
            </div>
        </div>

        <div class="alert-area">
            <div class="alert-text" id="alertText"></div>
        </div>
    </main>

    <!-- å´é‚Šæ¬„ï¼šè€ƒç¨‹è¡¨ -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>ä»Šæ—¥æ®µè€ƒæ—¥ç¨‹</h2>
        </div>
        <div class="schedule-list" id="scheduleList">
            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </aside>

    <script>
        // --- è¨­å®šå€ ---
        const CSV_FILE_PATH = 'exam_schedule.csv';
        
        // é è¨­è³‡æ–™ (è‹¥ CSV è®€å–å¤±æ•—æ™‚ä½¿ç”¨)
        let EXAM_DATA = [
            { start: "08:15", end: "09:00", subject: "ç¯„ä¾‹:åœ‹æ–‡" },
            { start: "09:10", end: "09:55", subject: "ç¯„ä¾‹:å‚™èª²" },
            { start: "10:05", end: "10:50", subject: "ç¯„ä¾‹:è‡ªç„¶" },
            { start: "13:30", end: "14:15", subject: "ç¯„ä¾‹:åœ°ç†" },
        ];

        // --- è®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const canvas = document.getElementById('examCanvas');
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 200;
        const lineWidth = 25;

        // æ™‚é–“æ ¡æ­£ (æ¯«ç§’)
        let globalTimeOffset = 0; 

        // é¡è‰²å®šç¾©
        const COLORS = {
            blue: '#4299e1',
            orange: '#ed8936',
            red: '#f56565',
            green: '#48bb78',
            gray: '#e2e8f0',
            bg: '#f0f4f8'
        };

        // --- ä¸»è¦é‚è¼¯ ---

        async function init() {
            // è®€å–æ ¡æ­£å€¼
            const savedOffset = localStorage.getItem('examClockOffset');
            if (savedOffset) {
                globalTimeOffset = parseInt(savedOffset);
                updateCalInfo();
            }

            // å˜—è©¦è®€å– CSV
            await loadCSV();

            // å•Ÿå‹•è¿´åœˆ
            renderSidebar();
            setInterval(updateLoop, 1000);
            updateLoop(); 
        }

        async function loadCSV() {
            try {
                const response = await fetch(CSV_FILE_PATH);
                if (!response.ok) throw new Error("CSV Not Found");
                
                // --- ä¿®æ”¹é‡é»ï¼šè§£æ±º CSV äº‚ç¢¼å•é¡Œ ---
                // ä½¿ç”¨ ArrayBuffer è®€å–åŸå§‹è³‡æ–™ï¼Œä¸¦ç”¨ TextDecoder('big5') å¼·åˆ¶è½‰ç¢¼
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('big5'); 
                const text = decoder.decode(buffer);
                // ------------------------------------

                const lines = text.trim().split(/\r?\n/); // è™•ç†ä¸åŒæ›è¡Œç¬¦è™Ÿ
                
                const newData = [];
                // å‡è¨­ CSV æ²’æœ‰æ¨™é¡Œåˆ—ï¼Œç›´æ¥å¾ç¬¬ä¸€è¡Œé–‹å§‹
                // æ ¼å¼ï¼šé–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,ç§‘ç›®
                for (let line of lines) {
                    const parts = line.split(',');
                    if (parts.length >= 3) {
                        newData.push({
                            start: parts[0].trim(),
                            end: parts[1].trim(),
                            subject: parts[2].trim()
                        });
                    }
                }

                if (newData.length > 0) {
                    EXAM_DATA = newData;
                    console.log("CSV è¼‰å…¥æˆåŠŸ (Big5è§£ç¢¼)", EXAM_DATA);
                }

            } catch (error) {
                console.warn("ç„¡æ³•è®€å– CSV æª”æ¡ˆï¼Œå°‡ä½¿ç”¨é è¨­/ç¯„ä¾‹è³‡æ–™ã€‚", error);
                // ä¿æŒä½¿ç”¨é è¨­ EXAM_DATA
            }
        }

        // --- æ ¡æ­£åŠŸèƒ½ ---
        function toggleCalibration() {
            const panel = document.getElementById('calibrationPanel');
            panel.classList.toggle('show');
        }

        function adjustTime(ms) {
            globalTimeOffset += ms;
            localStorage.setItem('examClockOffset', globalTimeOffset);
            updateCalInfo();
            updateLoop(); 
        }

        function resetCalibration() {
            globalTimeOffset = 0;
            localStorage.setItem('examClockOffset', 0);
            updateCalInfo();
            updateLoop();
        }

        function updateCalInfo() {
            const sec = globalTimeOffset / 1000;
            const sign = sec > 0 ? '+' : '';
            document.getElementById('calInfo').textContent = `ç›®å‰æ ¡æ­£: ${sign}${sec} ç§’`;
        }

        // --- æ›´æ–°è¿´åœˆ ---
        function updateLoop() {
            let now = new Date();
            now = new Date(now.getTime() + globalTimeOffset);
            
            renderClock(now);
            renderStatus(now);
        }

        function renderClock(dateObj) {
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('timeDisplay').textContent = timeStr;
            
            const dateOptions = { month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('dateDisplay').textContent = dateObj.toLocaleDateString('zh-TW', dateOptions);
        }

        function renderStatus(now) {
            const nowTime = now.getTime();
            let activeSlot = null;
            let nextSlot = null;

            // è§£ææ™‚é–“
            const schedule = EXAM_DATA.map(item => {
                const s = new Date(now);
                const [sH, sM] = item.start.split(':');
                s.setHours(parseInt(sH), parseInt(sM), 0, 0);

                const e = new Date(now);
                const [eH, eM] = item.end.split(':');
                e.setHours(parseInt(eH), parseInt(eM), 0, 0);

                return { ...item, startTime: s, endTime: e };
            });

            // ç‹€æ…‹åˆ¤æ–·
            for (let i = 0; i < schedule.length; i++) {
                const slot = schedule[i];
                if (nowTime >= slot.startTime.getTime() && nowTime <= slot.endTime.getTime()) {
                    activeSlot = slot;
                    break;
                }
                if (nowTime < slot.startTime.getTime()) {
                    nextSlot = slot;
                    break;
                }
            }

            // æ›´æ–°å´é‚Šæ¬„
            schedule.forEach((slot, index) => {
                const el = document.getElementById(`slot-${index}`);
                if (!el) return; // é˜²å‘†

                el.classList.remove('past', 'active');
                
                if (nowTime > slot.endTime.getTime()) {
                    el.classList.add('past');
                } else if (nowTime >= slot.startTime.getTime() && nowTime <= slot.endTime.getTime()) {
                    el.classList.add('active');
                }
            });

            // Canvas & è¨Šæ¯
            const centerSubject = document.getElementById('centerSubject');
            const centerStatus = document.getElementById('centerStatus');
            const alertText = document.getElementById('alertText');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawArc(1, COLORS.gray);

            if (activeSlot) {
                const totalDuration = activeSlot.endTime - activeSlot.startTime;
                const elapsed = nowTime - activeSlot.startTime;
                const remaining = activeSlot.endTime - nowTime;
                const progress = elapsed / totalDuration;
                const remainingMins = Math.ceil(remaining / 1000 / 60);

                centerSubject.textContent = activeSlot.subject;
                centerSubject.style.color = varToHex('--text-primary');

                let mainColor = COLORS.blue;
                let statusText = `å‰©é¤˜ ${remainingMins} åˆ†é˜`;
                let alertMsg = "";
                let alertShow = false;

                if (activeSlot.subject.includes("å‚™èª²")) {
                    mainColor = COLORS.green;
                    statusText = "æº–å‚™ä¸‹ä¸€ç¯€è€ƒè©¦";
                    centerSubject.style.color = COLORS.green;
                } else {
                    if (remainingMins <= 5) {
                        mainColor = COLORS.red;
                        alertMsg = `âš ï¸ ${activeSlot.subject} è€ƒè©¦å³å°‡çµæŸï¼è«‹æª¢æŸ¥è©¦å·`;
                        alertShow = true;
                    } else if (remainingMins <= 10) {
                        mainColor = COLORS.orange;
                        alertMsg = `ğŸ”” æ³¨æ„æ™‚é–“ï¼šå‰©é¤˜ ${remainingMins} åˆ†é˜`;
                        alertShow = true;
                    }
                }

                centerStatus.textContent = statusText;
                centerStatus.style.color = mainColor;
                drawArc(progress, mainColor);

                if (alertShow) {
                    alertText.textContent = alertMsg;
                    alertText.style.display = 'block';
                } else {
                    alertText.style.display = 'none';
                }

            } else if (nextSlot) {
                centerSubject.textContent = "ä¼‘æ¯ä¸­";
                centerStatus.textContent = `ä¸‹ç¯€ï¼š${nextSlot.subject} (${nextSlot.start})`;
                centerStatus.style.color = COLORS.textSecondary;
                alertText.style.display = 'none';
                drawArc(0, COLORS.blue);

            } else {
                const lastSlot = schedule[schedule.length - 1];
                if (lastSlot && nowTime > lastSlot.endTime.getTime()) {
                    centerSubject.textContent = "ä»Šæ—¥çµæŸ";
                    centerStatus.textContent = "è¾›è‹¦äº†ï¼";
                    centerStatus.style.color = COLORS.green;
                    drawArc(1, COLORS.green);
                } else {
                    centerSubject.textContent = "æº–å‚™ä¸­";
                    centerStatus.textContent = "";
                }
                alertText.style.display = 'none';
            }
        }

        function drawArc(percentage, color) {
            if (percentage <= 0) return;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI * percentage);
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function renderSidebar() {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '';
            EXAM_DATA.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'schedule-item';
                div.id = `slot-${index}`;
                div.innerHTML = `
                    <span class="item-time">${item.start} - ${item.end}</span>
                    <span class="item-subject">${item.subject}</span>
                `;
                list.appendChild(div);
            });
        }

        function varToHex(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        window.onload = init;

    </script>
</body>
</html>
